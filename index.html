<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>訪問看護スケジュール管理</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<style>
  :root{
    --brand:#2F7DF6; --brand-2:#6BB6FF; --bg:#F6FAFF; --panel:#FFFFFF; --line:#D9E7FB;
    --text:#0C1B2A; --muted:#6E7F95; --chip:#EEF6FF; --danger:#E05252; --ok:#2FBF71;
    --event-border:rgba(255,255,255,.96); --modal-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  body{font-family:'Noto Sans JP',system-ui,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  header{
    background:linear-gradient(90deg,var(--brand),var(--brand-2));
    color:#fff;padding:10px 16px;
    display:flex;flex-direction:column;align-items:flex-start;gap:6px;
  }
  header h1{margin:0;font-size:1.06rem;letter-spacing:.2px}
  header .btns{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;width:100%}
  header .btns button{
    height:36px;line-height:36px;border-radius:10px;padding:0 10px;
    border:1px solid rgba(255,255,255,.85);background:rgba(255,255,255,.12);
    color:#fff;font-weight:800;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.15);transition:.15s ease;
  }
  header .btns button:hover{background:rgba(255,255,255,.22);transform:translateY(-1px);}
  #btnPrintCurrentA4{
    background:linear-gradient(180deg,var(--brand-2),var(--brand));
    border-color:rgba(255,255,255,.9);box-shadow:0 2px 8px rgba(47,125,246,.28);
  }

  .layout{display:grid;grid-template-columns:380px 1fr;gap:12px;height:calc(100vh - 108px);padding:12px;box-sizing:border-box}
  aside,main{background:var(--panel);border-radius:14px;overflow:auto;border:1px solid var(--line)}
  aside{padding:14px;position:relative}
  main{padding:6px}
  h3{margin:8px 0;font-size:1rem}
  label{display:block;margin:6px 0 4px;font-weight:700}
  input,select,button,textarea{width:100%;padding:11px;border:1px solid var(--line);border-radius:10px;box-sizing:border-box;font-size:1rem}
  input::placeholder{color:#9fb4cf}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;display:flex;align-items:center;gap:8px}
  aside .row>button{background:var(--brand);color:#fff;border-color:var(--brand);font-weight:800;box-shadow:0 1px 4px rgba(47,125,246,.18)}
  .chip>button{background:var(--danger);color:#fff;border-color:var(--danger);padding:6px 10px;border-radius:999px;font-weight:800}
  .chip .ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
  .sticky-bottom .primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));border-color:var(--brand);color:#fff;box-shadow:0 2px 8px rgba(47,125,246,.28)}

  #calendar{min-height:78vh}
  @media (max-width:768px){
    .layout{grid-template-columns:1fr;height:auto}aside{order:2}main{order:1}
    header .btns{grid-template-columns:repeat(auto-fit,minmax(120px,1fr));}
  }

  .fc-v-event{border:2px solid var(--event-border);border-radius:12px;padding:4px 6px;font-weight:800;overflow:hidden;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.12);opacity:.98}
  .fc-v-event:hover{filter:brightness(1.04);transform:translateY(-1px);transition:.15s}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:999}
  .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:14px;box-shadow:var(--modal-shadow);padding:16px;z-index:1000;min-width:360px;max-width:92vw;border:1px solid var(--line)}
  .modal h3{margin-top:0}
  .actions{display:flex;gap:8px;margin-top:10px}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#fff;border-color:var(--brand)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn.ghost{background:#fff;color:var(--brand);border-color:var(--brand)}

  body.header-hidden header{display:none;}
  #btnShowHeader{
    position:fixed;top:8px;left:8px;z-index:1100;padding:8px 12px;border-radius:12px;border:1px solid var(--brand);
    background:#fff;color:var(--brand);font-weight:800;cursor:pointer;box-shadow:0 3px 12px rgba(0,0,0,.15);
  }
  body:not(.header-hidden) #btnShowHeader{display:none;}

  /* スタッフ別ボード */
  #staffBoard{display:none;gap:10px}
  #staffBoard.active{display:grid}
  #staffBoard .col{min-width:280px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
  #staffBoard .col h4{margin:0;padding:8px 10px;background:#f0f6ff;border-bottom:1px solid var(--line)}
  #staffBoard .calHost{padding:6px}
  #staffBoardControls{display:none;gap:8px;align-items:center;margin:6px 0;}
  #staffBoardControls.active{display:flex;}

  /* 印刷テキスト要約 */
  #printView{display:none;background:#fff;padding:12px;}
  #printView h2{margin:8px 0 4px;}
  #printView h3{margin:8px 0 4px;font-size:.98rem}
  #printView .sec{margin-top:8px;padding-top:6px;border-top:1px dashed #bbb;}
  #printView ul{margin:4px 0 8px 1.2em}
  #printView .muted{color:#666;font-size:.92em}
  @media print {
    header, aside, #calendar, #staffBoard, #staffBoardControls {display:none!important;}
    .layout{grid-template-columns:1fr}
    main{border:none}
    #printView{display:block!important;}
    @page{size:A4 portrait;margin:9mm;}
  }

  /* もっと見る */
  .list-collapsed{max-height:140px;overflow:hidden;position:relative}
  .list-collapsed::after{content:"";position:absolute;left:0;right:0;bottom:0;height:48px;background:linear-gradient(to bottom, rgba(255,255,255,0), var(--panel));pointer-events:none}
  .show-more-btn{margin-top:6px;width:100%;background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-weight:800;color:var(--text);cursor:pointer;display:block}
  .show-more-btn:hover{filter:brightness(1.03)}

  /* サイドバーON/OFF */
  body.sidebar-collapsed .layout{grid-template-columns:1fr!important}
  body.sidebar-collapsed aside{display:none!important}
  body.edge-to-edge .layout{padding:0!important}
  body.edge-to-edge main{padding:0!important;border:none!important;border-radius:0!important}
</style>
</head>

<body class="edge-to-edge">
<button id="btnShowHeader">ヘッダー表示</button>

<header>
  <h1>訪問看護スケジュール管理</h1>
  <div class="btns">
    <button id="btnResetWeek">今週分を消去</button>
    <button id="btnPrintCurrentA4">A4印刷(画面表示)</button>
    <button id="btnToggleSidebar">サイドバー ON/OFF</button>
    <button id="btnToggleHeader">ヘッダー非表示</button>
    <button id="btnViewToggle" title="標準カレンダー／スタッフ別ボード">表示：標準</button>
  </div>
</header>

<div class="layout">
  <aside>
    <h3>拠点（事務所）</h3>
    <div class="row">
      <input id="officeAddress" placeholder="拠点住所（例：大阪府大阪市...）">
      <button id="btnSaveOffice">拠点保存/再ジオコーディング</button>
    </div>
    <div id="officeInfo" class="muted" style="font-size:.92rem"></div>

    <h3>スタッフ登録</h3>
    <div class="row">
      <input id="staffName" placeholder="氏名（例：佐藤）" />
      <select id="staffType" style="max-width:120px"><option value="FT">常勤</option><option value="PT">非常勤</option></select>
    </div>
    <div class="row"><button id="addStaff">追加</button></div>
    <div id="staffList" class="chips"></div>

    <h3>出勤パターン（複数帯OK）</h3>
    <label>スタッフ</label><select id="shiftStaff"></select>
    <label>曜日</label><div id="shiftDays" class="row"></div>
    <label>勤務時間</label>
    <div class="row"><input id="shiftStart" type="time" value="09:00" style="flex:1"><input id="shiftEnd" type="time" value="18:00" style="flex:1"></div>
    <div class="row"><button id="addShift">出勤パターン追加</button></div>
    <div id="shiftList" class="chips"></div>

    <h3>利用者登録</h3>
    <div class="row">
      <input id="userName" placeholder="利用者氏名（例：田中）" />
      <select id="userDuration" style="max-width:120px"><option value="60">60分</option><option value="30">30分</option></select>
    </div>
    <input id="userAddress" placeholder="住所（任意）：例）大阪府大阪市浪速区恵美須西3-8-8" />
    <div class="row"><button id="addUser">追加</button></div>
    <div id="userList" class="chips"></div>

    <h3>基本訪問パターン</h3>
    <label>利用者</label><select id="patternUser"></select>
    <label>曜日</label><div id="patternDays" class="row"></div>
    <label>開始時刻</label><input id="patternTime" type="time" value="09:00" />
    <div class="row"><button id="addPattern">パターン追加</button></div>
    <div id="patternList" class="chips"></div>

    <h3>NG設定（スタッフ別・複数選択）</h3>
    <label>スタッフ</label><select id="ngStaff"></select>
    <label>NGにする利用者（複数選択可）</label>
    <div id="ngUsers" class="row" style="max-height:140px; overflow:auto; border:1px dashed var(--line); padding:8px; border-radius:10px"></div>
    <div class="row"><button id="btnAddNG">NG保存</button></div>

    <div class="sticky-bottom">
      <button id="btnAutoAssignBottom" class="primary">自動割当（表示週）</button>
    </div>
  </aside>

  <main>
    <div id="calendar"></div>

    <!-- スタッフ別ボード：日付コントロール -->
    <div id="staffBoardControls">
      <button id="sbPrev">◀ 前日</button>
      <input id="sbDate" type="date" style="max-width:180px">
      <button id="sbNext">翌日 ▶</button>
    </div>
    <div id="staffBoard" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(280px,1fr));"></div>

    <!-- 印刷用のテキスト要約 -->
    <div id="printView"></div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  // ====== Utils ======
  const STORAGE_KEY='vk_data_final_v7';
  const jp=['日','月','火','水','木','金','土'];
  const dayNamesJP=['月','火','水','木','金','土','日'];
  const fmtDateLocal=(d)=>{const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;};
  const addMinStr=(hhmm, mins)=>{const [h,m]=hhmm.split(':').map(Number);const dt=new Date();dt.setHours(h);dt.setMinutes(m+mins);return dt.toTimeString().slice(0,5)};
  const ceilTo15=(date)=>{const ms=15*60*1000;return new Date(Math.ceil(date.getTime()/ms)*ms)};
  const uid=()=>Math.random().toString(36).slice(2,9);
  const isMobile=()=>window.matchMedia('(max-width:768px)').matches;
  const getWeekRange=(base)=>{const monday=new Date(base);monday.setDate(base.getDate()-((base.getDay()+6)%7));monday.setHours(0,0,0,0);return {monday,nextMonday:new Date(monday.getTime()+7*24*60*60*1000)}};
  function colorByStaffName(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0; const hue=h%360; return `hsl(${hue} 85% 82%)`; }
  function parseTitleStaff(ev){
    const t=ev?.title||''; const ep=ev?.extendedProps||{};
    if(ep.staffName) return ep.staffName;
    const m=/（(.+?)）\s*$/.exec(t); return m?m[1]:'';
  }
  function parseTitleUser(ev){ const m=/^(.*)（/.exec(ev.title||''); return m?m[1]:ev.title||''; }

  // ====== Geo helpers ======
  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  function toHalfWidthNum(str){return (str||'').replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0)-0xFEE0));}
  function normalizeHyphen(str){return (str||'').replace(/[ー−–—‐-﹣－]/g, '-');}
  function normalizeJPAddress(raw){
    if(!raw) return '';
    let s = raw.trim();
    s = toHalfWidthNum(s);
    s = normalizeHyphen(s);
    s = s.replace(/(\d+)\s*丁目/g, '$1-');
    s = s.replace(/(\d+)\s*番地?/g, '$1-');
    s = s.replace(/(\d+)\s*号/g, '$1-');
    s = s.replace(/(\d+)\s*の\s*(\d+)/g, '$1-$2');
    s = s.replace(/\s+/g, ' ').replace(/\s*-\s*/g, '-');
    s = s.replace(/(市|区|郡)([^\s\d-]+)/, '$1 $2');
    s = s.replace(/-+$/,'');
    return s;
  }
  function buildJPVariants(address){
    const raw = (address||'').trim();
    const base = normalizeJPAddress(raw);
    const withJP = `${base}, 日本`;
    return Array.from(new Set([raw, base, withJP]));
  }
  async function geocodeNominatim(q){
    if(!q) return null;
    const params = new URLSearchParams({format:'jsonv2', q, limit:'1', addressdetails:'0', countrycodes:'jp'});
    const url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;
    try{
      const res = await fetch(url, { headers:{ 'Accept-Language':'ja' }});
      if(!res.ok) return null;
      const data = await res.json();
      if(data && data[0]){
        const lat = Number(data[0].lat), lng = Number(data[0].lon);
        if(Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
      }
    }catch(e){}
    return null;
  }
  async function geocodeGSI(q){
    if(!q) return null;
    const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(q)}`;
    try{
      const res = await fetch(url);
      if(!res.ok) return null;
      const data = await res.json();
      const f = Array.isArray(data) ? data[0] : null;
      const coords = f?.geometry?.coordinates; // [lon,lat]
      if(Array.isArray(coords) && coords.length>=2){
        const lng = Number(coords[0]), lat = Number(coords[1]);
        if(Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
      }
    }catch(e){}
    return null;
  }
  function cityOnlyVariant(address){
    const s = normalizeJPAddress(address||'');
    const m = /(.*?[都道府県])\s*([^\s\d-]*市)?([^\s\d-]*区)?/.exec(s);
    if(!m) return '';
    return [m[1], m[2]||'', m[3]||''].join(' ').replace(/\s+/g,' ').trim();
  }
  async function geocodeAddress(address){
    const variants = buildJPVariants(address);
    for(const v of variants){
      const p = await geocodeNominatim(v);
      if(p) return p;
      await sleep(150);
    }
    for(const v of variants){
      const p = await geocodeGSI(v);
      if(p) return p;
      await sleep(120);
    }
    const city = cityOnlyVariant(address);
    if(city){
      const p = await geocodeNominatim(city + ', 日本');
      if(p) return p;
    }
    return null;
  }

  // ====== State ======
  let office={address:'', lat:null, lng:null};
  let staff=[], users=[], patterns=[], shifts=[], events=[];
  let skippedAssignments=[];
  let viewMode='standard';
  let staffBoardDate = new Date();

  // ====== DOM refs ======
  const el={
    officeAddress:document.getElementById('officeAddress'),
    btnSaveOffice:document.getElementById('btnSaveOffice'),
    officeInfo:document.getElementById('officeInfo'),

    staffName:document.getElementById('staffName'), staffType:document.getElementById('staffType'), addStaff:document.getElementById('addStaff'), staffList:document.getElementById('staffList'),
    userName:document.getElementById('userName'), userDuration:document.getElementById('userDuration'), addUser:document.getElementById('addUser'), userList:document.getElementById('userList'), userAddress:document.getElementById('userAddress'),
    patternUser:document.getElementById('patternUser'), patternDays:document.getElementById('patternDays'), patternTime:document.getElementById('patternTime'), addPattern:document.getElementById('addPattern'), patternList:document.getElementById('patternList'),
    shiftStaff:document.getElementById('shiftStaff'), shiftDays:document.getElementById('shiftDays'), shiftStart:document.getElementById('shiftStart'), shiftEnd:document.getElementById('shiftEnd'), addShift:document.getElementById('addShift'), shiftList:document.getElementById('shiftList'),
    btnAutoAssignBottom:document.getElementById('btnAutoAssignBottom'), btnResetWeek:document.getElementById('btnResetWeek'),
    calendarHost:document.getElementById('calendar'),
    btnPrintCurrentA4:document.getElementById('btnPrintCurrentA4'),
    btnToggleSidebar:document.getElementById('btnToggleSidebar'),
    btnToggleHeader:document.getElementById('btnToggleHeader'),
    btnShowHeader:document.getElementById('btnShowHeader'),
    ngStaff:document.getElementById('ngStaff'), ngUsers:document.getElementById('ngUsers'), btnAddNG:document.getElementById('btnAddNG'),
    staffBoard:document.getElementById('staffBoard'), btnViewToggle:document.getElementById('btnViewToggle'),
    sbControls:document.getElementById('staffBoardControls'), sbPrev:document.getElementById('sbPrev'), sbNext:document.getElementById('sbNext'), sbDate:document.getElementById('sbDate'),
    printView:document.getElementById('printView')
  };

  // ====== Storage ======
  const save=()=>localStorage.setItem(STORAGE_KEY, JSON.stringify({office,staff,users,patterns,shifts,events}));
  const load=()=>{try{
    const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
    const d=JSON.parse(raw);
    office = d.office||{address:'',lat:null,lng:null};
    staff=(d.staff||[]).map(s=>({...s, ngUserIds: s.ngUserIds||[]}));
    users=(d.users||[]).map(u=>({...u}));
    patterns=d.patterns||[]; shifts=d.shifts||[];
    events=(d.events||[]).map(ev=>{
      const sname=parseTitleStaff(ev);
      return { id: ev.id || uid(), title: ev.title, start: ev.start, end: ev.end,
               extendedProps:{...(ev.extendedProps||{}), staffName:sname},
               backgroundColor: ev.backgroundColor, borderColor: ev.borderColor };
    });
  }catch(e){console.error('load failed',e)}};

  // ====== Render helpers ======
  const sortByName = (a,b)=> (a.name||'').localeCompare(b.name||'','ja');

  const hydrateSelects=()=>{
    const staffSorted=[...staff].sort(sortByName);
    el.shiftStaff.innerHTML=''; staffSorted.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; el.shiftStaff.appendChild(o); });
    el.ngStaff.innerHTML=''; staffSorted.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.name}（${s.type==='PT'?'非常勤':'常勤'}）`; el.ngStaff.appendChild(o); });

    const usersSorted=[...users].sort(sortByName);
    el.patternUser.innerHTML=''; usersSorted.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.name; el.patternUser.appendChild(o); });

    // NG 候補一覧（チェック付与は ngStaff 変更時）
    el.ngUsers.innerHTML='';
    usersSorted.forEach(u=>{
      const lab=document.createElement('label'); lab.className='chip';
      lab.innerHTML=`<input type="checkbox" value="${u.id}"> ${u.name}`;
      el.ngUsers.appendChild(lab);
    });
  };

  const renderStaff=()=>{
    const staffSorted=[...staff].sort(sortByName);
    el.staffList.innerHTML='';
    staffSorted.forEach(s=>{
      const ngNames=(s.ngUserIds||[]).map(id=>users.find(u=>u.id===id)?.name).filter(Boolean);
      const ngText=ngNames.length? `｜NG: ${ngNames.join('・')}` : '';
      el.staffList.innerHTML+=`
        <span class='chip'>
          ${s.name}（${s.type==='PT'?'非常勤':'常勤'}） ${ngText}
          <button class='ghost editStaff' data-id='${s.id}'>編集</button>
          <button class='delStaff' data-id='${s.id}'>削除</button>
        </span>`;
    });
  };

  const renderUsers=()=>{
    const usersSorted=[...users].sort(sortByName);
    el.userList.innerHTML='';
    usersSorted.forEach(u=>{
      const addr=u.address||'(住所なし)';
      const latlng=(Number.isFinite(u.lat)&&Number.isFinite(u.lng))? `${u.lat.toFixed(4)}, ${u.lng.toFixed(4)}` : '(未取得)';
      el.userList.innerHTML+=`
        <span class='chip'>
          ${u.name}（${u.duration||60}分） ｜ 住所：${addr} ｜ 座標：${latlng}
          <button class='ghost editUser' data-id='${u.id}'>編集</button>
          <button class='delUser' data-id='${u.id}'>削除</button>
        </span>`;
    });
  };

  const renderPatterns=()=>{
    el.patternList.innerHTML='';
    const usersMap = new Map(users.map(u=>[u.id,u]));
    patterns.forEach(p=>{
      const u=usersMap.get(p.userId);
      el.patternList.innerHTML += `
        <span class='chip'>
          ${u?u.name:'不明'}：${(p.days||[]).join('・')} ${p.time||''}
          <button class='ghost editPattern' data-id='${p.id}'>編集</button>
          <button class='delPattern' data-id='${p.id}'>削除</button>
        </span>`;
    });
  };

  const renderShifts=()=>{ el.shiftList.innerHTML=''; shifts.forEach(s=>{ const stf=staff.find(x=>x.id===s.staffId); el.shiftList.innerHTML=`${el.shiftList.innerHTML}<span class='chip'>${stf?stf.name:'不明'}：${s.days.join('・')} ${s.start}〜${s.end} <button class='delShift' data-id='${s.id}'>削除</button></span>`; }); };
  const renderOffice=()=>{
    el.officeAddress.value = office.address||'';
    const txt = (Number.isFinite(office.lat)&&Number.isFinite(office.lng)) ? `座標：${office.lat.toFixed(5)}, ${office.lng.toFixed(5)}` : '座標未取得';
    el.officeInfo.textContent = office.address ? `${office.address} ｜ ${txt}` : '未設定';
  }
  const renderAll=()=>{ hydrateSelects(); renderStaff(); renderUsers(); renderPatterns(); renderShifts(); renderOffice(); refreshNGChecksForSelectedStaff(); };

  // ====== 距離計算（ハバースィン） ======
  function haversineKm(a, b){
    if(!a||!b||!Number.isFinite(a.lat)||!Number.isFinite(a.lng)||!Number.isFinite(b.lat)||!Number.isFinite(b.lng)) return Number.POSITIVE_INFINITY;
    const toRad = d=>d*Math.PI/180;
    const R = 6371;
    const dLat = toRad(b.lat-a.lat), dLng = toRad(b.lng-a.lng);
    const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(s));
  }
  function getUserGeoByName(name){
    const u = users.find(x=>x.name===name);
    if(u && Number.isFinite(u.lat) && Number.isFinite(u.lng)) return {lat:u.lat, lng:u.lng};
    return null;
  }
  function officeGeo(){ return (Number.isFinite(office.lat)&&Number.isFinite(office.lng))? {lat:office.lat,lng:office.lng} : null; }
  function lastEventBefore(staffName, dayISO, startISO){
    const sDay = new Date(dayISO+'T00:00:00');
    const eDay = new Date(dayISO+'T23:59:59');
    let last=null;
    (events||[]).forEach(ev=>{
      const sn=parseTitleStaff(ev);
      if(sn!==staffName) return;
      const s=new Date(ev.start), e=new Date(ev.end||ev.start);
      if(s>=sDay && e<=eDay && e<=new Date(startISO)){
        if(!last || e>new Date(last.end)) last=ev;
      }
    });
    return last;
  }

  // ====== 標準カレンダー ======
  const calendar=new FullCalendar.Calendar(el.calendarHost,{
    timeZone:'local',
    headerToolbar: isMobile()? {left:'prev,next today',center:'title',right:'timeGridDay'} : {left:'prev,next today',center:'title',right:'timeGridWeek,timeGridDay'},
    initialView: isMobile()? 'timeGridDay' : 'timeGridWeek',
    firstDay:1, locale:'ja', height:'auto',
    slotMinTime:'09:00', slotMaxTime:'18:00',
    expandRows:true, stickyHeaderDates:true,
    editable:true, eventOverlap:true, slotEventOverlap:true, nowIndicator:true,
    slotDuration:'00:15:00', snapDuration:'00:15:00', allDaySlot:false,
    events:(info,success)=>{ success((events||[]).map(e=>({...e}))); },
    eventDidMount:(info)=>{
      const sn = parseTitleStaff(info.event);
      info.event.setExtendedProp('staffName', sn);
      const col=colorByStaffName(sn);
      info.event.setProp('backgroundColor', col);
      info.event.setProp('borderColor', 'var(--event-border)');
      info.el.style.background=col; info.el.style.borderColor='var(--event-border)';
    },
    eventDrop:(info)=>{ snapAndPersist(info.event); },
    eventResize:(info)=>{ snapAndPersist(info.event); },

    // === 訪問追加モーダル（安定化） ===
    dateClick:(info)=>{
      const start = new Date(info.dateStr);
      const startStr = start.toTimeString().slice(0,5);
      const overlay=document.createElement('div'); overlay.className='overlay';
      const box=document.createElement('div'); box.className='modal';
      const staffOptions = [...staff].sort(sortByName).map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
      const userOptions  = [...users].sort(sortByName).map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
      box.innerHTML = `
        <h3>訪問イベント追加</h3>
        <div class="row">
          <div style="flex:1">
            <label>開始</label>
            <input id="evStart" type="time" value="${startStr}">
          </div>
          <div style="flex:1">
            <label>時間（分）</label>
            <select id="evDur"><option value="30">30</option><option value="60" selected>60</option><option value="90">90</option></select>
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>スタッフ（選択）</label>
            <select id="evStaffSel"><option value="">未選択</option>${staffOptions}</select>
          </div>
          <div style="flex:1">
            <label>スタッフ（手打ち）</label>
            <input id="evStaffTxt" placeholder="例）佐藤">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>利用者（選択）</label>
            <select id="evUserSel"><option value="">未選択</option>${userOptions}</select>
          </div>
          <div style="flex:1">
            <label>利用者（手打ち）</label>
            <input id="evUserTxt" placeholder="例）田中">
          </div>
        </div>
        <div class="actions">
          <button id="evSave" class="btn primary">追加</button>
          <button id="evClose" class="btn ghost">閉じる</button>
        </div>
      `;
      document.body.appendChild(overlay);
      document.body.appendChild(box);

      // 外側クリックのみ閉じる（内部クリックでは閉じない）
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });
      function close(){ overlay.remove(); box.remove(); }
      document.getElementById('evClose').onclick=close;

      document.getElementById('evSave').onclick=()=>{
        const st = document.getElementById('evStart').value || '09:00';
        const dur = parseInt(document.getElementById('evDur').value)||60;

        const staffSel = document.getElementById('evStaffSel').value.trim();
        const staffTxt = document.getElementById('evStaffTxt').value.trim();
        const userSel  = document.getElementById('evUserSel').value.trim();
        const userTxt  = document.getElementById('evUserTxt').value.trim();

        const staffName = staffTxt || staffSel;
        const userName  = userTxt  || userSel;

        if(!staffName || !userName){ alert('スタッフと利用者を入力または選択してください'); return; }

        const day = fmtDateLocal(start);
        const endStr = (function(hhmm,m){ const [h,mi]=hhmm.split(':').map(Number); const d=new Date(); d.setHours(h); d.setMinutes(mi+m); return d.toTimeString().slice(0,5);} )(st,dur);
        const col=colorByStaffName(staffName);
        events.push({
          id: uid(),
          title:`${userName}（${staffName}）`,
          start:`${day}T${st}:00`,
          end:`${day}T${endStr}:00`,
          extendedProps:{staffName},
          backgroundColor:col, borderColor:'var(--event-border)'
        });
        save(); calendar.refetchEvents(); close();
      };
    },

    eventClick:(info)=>{ openEditorById(info.event.id); }
  });

  function snapAndPersist(ev){
    const s=ceilTo15(ev.start); const e=ceilTo15(ev.end);
    ev.setDates(s,e,{maintainDuration:false});
    const sn = parseTitleStaff(ev);
    ev.setExtendedProp('staffName', sn);
    ev.setProp('backgroundColor', colorByStaffName(sn));
    ev.setProp('borderColor', 'var(--event-border)');
    persistEvents();
  }
  function persistEvents(){
    events = calendar.getEvents().map(ev=>({
      id: ev.id || uid(),
      title:ev.title, start:ev.start.toISOString(), end:ev.end.toISOString(),
      extendedProps:{...(ev.extendedProps||{})},
      backgroundColor: ev.backgroundColor, borderColor: ev.borderColor
    }));
    save();
  }

  // ==== イベント編集 ====
  function openEditorById(eventId){
    const rec = events.find(e=>e.id===eventId);
    if(!rec) return;
    const dStart = new Date(rec.start);
    const user=parseTitleUser(rec); const staffName=parseTitleStaff(rec);
    const dur = Math.round(((new Date(rec.end))-dStart)/60000) || 60;

    const overlay=document.createElement('div'); overlay.className='overlay';
    const box=document.createElement('div'); box.className='modal';
    box.innerHTML = `
      <h3>訪問プレビュー</h3>
      <div><strong>スタッフ：</strong>${staffName||'(未設定)'}</div>
      <div><strong>利用者：</strong>${user||'(未設定)'}</div>
      <div class="row" style="margin-top:6px">
        <div style="flex:1">
          <label>開始</label>
          <input id="pvStart" type="time" value="${dStart.toTimeString().slice(0,5)}">
        </div>
        <div style="flex:1">
          <label>時間（分）</label>
          <select id="pvDur"><option value="30" ${dur===30?'selected':''}>30</option><option value="60" ${dur===60?'selected':''}>60</option><option value="90" ${dur===90?'selected':''}>90</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div style="flex:1">
          <label>スタッフ</label>
          <select id="pvStaff">${[...new Set(staff.sort(sortByName).map(s=>s.name))].map(n=>`<option ${n===staffName?'selected':''}>${n}</option>`).join('')}</select>
        </div>
        <div style="flex:1">
          <label>利用者</label>
          <select id="pvUser">${[...new Set(users.sort(sortByName).map(u=>u.name))].map(n=>`<option ${n===user?'selected':''}>${n}</option>`).join('')}</select>
        </div>
      </div>
      <div class="actions">
        <button id="pvSave" class="btn primary">保存</button>
        <button id="pvDelete" class="btn danger">削除</button>
        <button id="pvClose" class="btn ghost">閉じる</button>
      </div>`;
    document.body.appendChild(overlay); document.body.appendChild(box);
    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) close(); });
    function close(){ overlay.remove(); box.remove(); }

    document.getElementById('pvClose').onclick=close;
    document.getElementById('pvDelete').onclick=()=>{
      if(confirm('削除しますか？')){
        events = events.filter(e=>e.id!==eventId);
        save(); calendar.refetchEvents(); if(viewMode==='staffBoard') renderStaffBoard(); close();
      }
    };
    document.getElementById('pvSave').onclick=()=>{
      const st = document.getElementById('pvStart').value || '09:00';
      const ndur = parseInt(document.getElementById('pvDur').value)||60;
      const stf = document.getElementById('pvStaff').value || staffName;
      const usr = document.getElementById('pvUser').value || user;
      const day = fmtDateLocal(new Date(rec.start));
      const endStr = (function(hhmm,m){ const [h,mi]=hhmm.split(':').map(Number); const d=new Date(); d.setHours(h); d.setMinutes(mi+m); return d.toTimeString().slice(0,5);} )(st,ndur);

      rec.title = `${usr}（${stf}）`;
      rec.start = `${day}T${st}:00`;
      rec.end   = `${day}T${endStr}:00`;
      rec.extendedProps = {...(rec.extendedProps||{}), staffName: stf};
      rec.backgroundColor = colorByStaffName(stf);
      rec.borderColor = 'var(--event-border)';
      save(); calendar.refetchEvents(); if(viewMode==='staffBoard') renderStaffBoard(); close();
    };
  }

  // ====== 自動割当（連続訪問を距離優先） ======
  function countAssignedForWeek(staffName, monday, nextMonday){
    let c=0;
    (events||[]).forEach(ev=>{
      const sn=parseTitleStaff(ev);
      if(sn===staffName){ const s=new Date(ev.start); if(s>=monday && s<nextMonday) c++; }
    });
    return c;
  }

  function autoAssignWeek(){
    if(staff.length===0){ alert('スタッフを登録してください'); return; }
    if(users.length===0){ alert('利用者を登録してください'); return; }
    const active = patterns.filter(p => p.active !== false);
    if(active.length===0){ alert('有効な基本訪問パターンがありません'); return; }

    const rng = getWeekRange(calendar.getDate());
    const monday = rng.monday; const nextMonday = rng.nextMonday;
    const inWeek = (iso)=>{ const d=new Date(iso); return d>=monday && d<nextMonday; };

    // 週の既存イベントはクリア
    events = (events||[]).filter(ev=> !inWeek(ev.start));
    skippedAssignments = [];

    const hasShiftLocal = (stfId, dayLabel, startStr, endStr)=>{
      const sh = shifts.filter(x=>x.staffId===stfId && x.days.includes(dayLabel));
      return sh.some(x=> x.start<=startStr && x.end>=endStr );
    };
    const weekdayLabel=(date)=>{ const idx=(date.getDay()+6)%7; return dayNamesJP[idx]; };

    // 近接性優先でのスタッフソート関数
    const sortByProximity = (candidates, dayISO, startStr, userGeo)=>{
      // userGeo が無ければ並べ替えしない
      if(!userGeo) return candidates;
      // 直前イベント地点（なければ拠点）からの距離で昇順
      const dayStartISO = `${dayISO}T00:00:00`;
      const startISO = `${dayISO}T${startStr}:00`;
      return [...candidates].sort((a,b)=>{
        const prevA = lastEventBefore(a.name, dayISO, startISO);
        const prevB = lastEventBefore(b.name, dayISO, startISO);
        const geoA = prevA ? getUserGeoByName(parseTitleUser(prevA)) || officeGeo() : officeGeo();
        const geoB = prevB ? getUserGeoByName(parseTitleUser(prevB)) || officeGeo() : officeGeo();
        const da = haversineKm(geoA, userGeo);
        const db = haversineKm(geoB, userGeo);
        if(da!==db) return da-db;
        // 同距離のときは名前で安定化
        return a.name.localeCompare(b.name,'ja');
      });
    };

    let placed=0;

    for(const p of active){
      const u = users.find(x=>x.id===p.userId);
      if(!u){ skippedAssignments.push({reason:'利用者不明', userId:p.userId}); continue; }

      for(const d of (p.days||[])){
        const idx = dayNamesJP.indexOf(d); if(idx<0){ skippedAssignments.push({reason:'曜日不正', userId:u.id}); continue; }
        const day = new Date(monday); day.setDate(monday.getDate()+idx);
        const dayISO = fmtDateLocal(day);

        const st = p.time; const en = addMinStr(st, u.duration);
        const startISO = `${dayISO}T${st}:00`;
        const endISO   = `${dayISO}T${en}:00`;
        const dayLabel = weekdayLabel(day);

        const candidatesAll = staff.filter(s=> hasShiftLocal(s.id,dayLabel,st,en)
                                           && !(s.ngUserIds||[]).includes(u.id));

        // 直前地点→今回ユーザーまでの距離を使って候補を並べ替え
        const uGeo = (Number.isFinite(u.lat)&&Number.isFinite(u.lng)) ? {lat:u.lat,lng:u.lng} : null;
        const candidates = sortByProximity(candidatesAll, dayISO, st, uGeo);

        const placeable=(cand)=>{
          const sn=cand.name; const ns=new Date(startISO), ne=new Date(endISO);
          const clash = (events||[]).some(ev=>{
            const name=parseTitleStaff(ev);
            if(name!==sn) return false;
            const s=new Date(ev.start), e=new Date(ev.end||ev.start);
            return !(e<=ns || s>=ne);
          });
          return !clash;
        };

        // 候補を順にチェック（距離→重複なし）
        let picked=null;
        for(const cand of candidates){ if(placeable(cand)){ picked=cand; break; } }

        if (!picked) {
          skippedAssignments.push({reason:'割当不可（NG/重複/不在）', userId:u.id, date:dayISO, start:st, end:en});
          continue;
        }

        const col=colorByStaffName(picked.name);
        events.push({
          id: uid(),
          title:`${u.name}（${picked.name}）`,
          start:startISO, end:endISO,
          extendedProps:{staffName:picked.name},
          backgroundColor:col, borderColor:'var(--event-border)'
        });
        placed++;
      }
    }
    save(); calendar.refetchEvents();
    showSkippedModal();
    alert(`自動割当 完了：配置 ${placed} 件 / 見送り ${skippedAssignments.length} 件（表示週）`);
  }

  function showSkippedModal(){
    if(!skippedAssignments.length) return;
    const overlay=document.createElement('div'); overlay.className='overlay';
    const box=document.createElement('div'); box.className='modal'; box.style.minWidth='600px';
    const rows = skippedAssignments.map((s,idx)=>{
      const uname = users.find(u=>u.id===s.userId)?.name || '(不明)';
      const date = s.date||'(日付)'; const st = s.start||'09:00'; const en = s.end||'10:00';
      const d=new Date(`${s.date||fmtDateLocal(new Date())}T00:00:00`);
      const dayLabel = dayNamesJP[(d.getDay()+6)%7];
      const cands = staff.filter(sf=>{
        const okShift = shifts.some(sh=> sh.staffId===sf.id && sh.days.includes(dayLabel) && sh.start<=st && sh.end>=en);
        const okNG = !(sf.ngUserIds||[]).includes(s.userId);
        return okShift && okNG;
      });
      const opts = cands.map(c=>`<option value="${c.id}">${c.name}（${c.type==='FT'?'常勤':'非常勤'}）</option>`).join('');
      return `
        <tr data-idx="${idx}">
          <td>${date}</td>
          <td><input type="time" class="sk-st" value="${st}"></td>
          <td><input type="time" class="sk-en" value="${en}"></td>
          <td>${uname}</td>
          <td><select class="sk-staff"><option value="">選択</option>${opts}</select></td>
          <td>${s.reason||''}</td>
          <td><button class="btn primary sk-place">配置</button></td>
        </tr>
      `;
    }).join('');
    box.innerHTML=`
      <h3>見送り一覧（編集して配置できます）</h3>
      <div style="max-height:50vh; overflow:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="text-align:left;">
              <th>日付</th><th>開始</th><th>終了</th><th>利用者</th><th>スタッフ</th><th>理由</th><th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="actions"><button id="skClose" class="btn ghost">閉じる</button></div>
    `;
    document.body.appendChild(overlay); document.body.appendChild(box);
    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) close(); });
    function close(){ overlay.remove(); box.remove(); }

    box.addEventListener('click', (e)=>{
      const t=e.target; if(!(t instanceof HTMLElement)) return;
      if(t.classList.contains('sk-place')){
        const tr=t.closest('tr'); const idx=parseInt(tr.dataset.idx);
        const rec=skippedAssignments[idx]; if(!rec) return;
        const st=tr.querySelector('.sk-st').value || rec.start;
        const en=tr.querySelector('.sk-en').value || rec.end;
        const sid=tr.querySelector('.sk-staff').value;
        if(!sid) return alert('スタッフを選択してください');

        const sf=staff.find(x=>x.id===sid); const u=users.find(x=>x.id===rec.userId);
        const startISO = `${rec.date}T${st}:00`; const endISO = `${rec.date}T${en}:00`;
        const col=colorByStaffName(sf.name);
        events.push({ id:uid(), title:`${u.name}（${sf.name}）`, start:startISO, end:endISO,
          extendedProps:{staffName:sf.name}, backgroundColor:col, borderColor:'var(--event-border)' });
        skippedAssignments.splice(idx,1); tr.remove();
        save(); calendar.refetchEvents(); if(viewMode==='staffBoard') renderStaffBoard();
      }
    });
    document.getElementById('skClose').onclick=close;
  }

  // ====== スタッフ別ボード（＋日付選択） ======
  let staffCalendars=[];
  function renderStaffBoard(){
    staffCalendars.forEach(sc=> sc.cal.destroy());
    staffCalendars=[];
    el.staffBoard.innerHTML='';

    const startDay=new Date(staffBoardDate); startDay.setHours(0,0,0,0);
    const endDay=new Date(startDay); endDay.setDate(endDay.getDate()+1);

    staff.sort(sortByName).forEach(s=>{
      const col=document.createElement('div'); col.className='col';
      col.innerHTML=`<h4>${s.name}（${s.type==='PT'?'非常勤':'常勤'}）</h4><div class="calHost"></div>`;
      el.staffBoard.appendChild(col);
      const host=col.querySelector('.calHost');

      const cal=new FullCalendar.Calendar(host,{
        timeZone:'local', headerToolbar:false, initialView:'timeGridDay',
        initialDate:startDay, visibleRange:{ start:startDay, end:endDay },
        firstDay:1, locale:'ja', height:600, slotMinTime:'09:00', slotMaxTime:'18:00',
        expandRows:true, nowIndicator:true, allDaySlot:false,
        dayHeaderFormat:{ weekday:'short', month:'numeric', day:'numeric' },
        events:(info,success)=>{
          const list=(events||[]).filter(e=>{
            const sn=parseTitleStaff(e); const d=new Date(e.start);
            return sn===s.name && d>=startDay && d<endDay;
          }).map(e=>({...e}));
          success(list);
        },
        eventDidMount:(info)=>{
          const colr=colorByStaffName(s.name);
          info.el.style.background=colr; info.el.style.borderColor='var(--event-border)';
        },
        eventClick:(info)=>{ openEditorById(info.event.id); }
      });
      cal.render();
      staffCalendars.push({id:s.id, cal});
    });
    el.sbDate.value = fmtDateLocal(startDay);
  }
  function switchViewMode(mode){
    viewMode=mode;
    if(mode==='standard'){
      el.calendarHost.style.display='';
      el.staffBoard.classList.remove('active');
      el.sbControls.classList.remove('active');
      el.btnViewToggle.textContent='表示：標準';
      calendar.updateSize();
    }else{
      el.calendarHost.style.display='none';
      el.staffBoard.classList.add('active');
      el.sbControls.classList.add('active');
      el.btnViewToggle.textContent='表示：スタッフ別';
      staffBoardDate = new Date(calendar.getDate());
      renderStaffBoard();
    }
  }
  el.sbPrev.addEventListener('click',()=>{ staffBoardDate.setDate(staffBoardDate.getDate()-1); renderStaffBoard(); });
  el.sbNext.addEventListener('click',()=>{ staffBoardDate.setDate(staffBoardDate.getDate()+1); renderStaffBoard(); });
  el.sbDate.addEventListener('change',(e)=>{ const v=e.target.value; if(v){ staffBoardDate=new Date(v+'T00:00:00'); renderStaffBoard(); }});

  // ====== 印刷：現在の表示に合わせて片方のみ ======
  function buildPrintHTML(){
    el.printView.innerHTML='';
    if(viewMode==='standard'){
      const isWeek = /Week/i.test(calendar.view.type);
      const baseDate = calendar.getDate();
      const days=[];
      if(isWeek){
        const {monday,nextMonday}=getWeekRange(baseDate);
        for(let d=new Date(monday); d<nextMonday; d.setDate(d.getDate()+1)){ days.push(new Date(d)); }
      }else{ days.push(new Date(baseDate)); }
      const within=(d)=>{ const h=d.getHours(); return h>=9 && h<18; };
      let html = `<h2>時間順要約</h2><div class="muted">※9:00〜18:00 のみ</div>`;
      days.forEach(day=>{
        const dstr=`${fmtDateLocal(day)}（${jp[day.getDay()]}）`;
        const list=(events||[]).filter(e=>{
          const s=new Date(e.start);
          return s.getFullYear()===day.getFullYear() && s.getMonth()===day.getMonth() && s.getDate()===day.getDate() && within(s);
        }).sort((a,b)=> new Date(a.start)-new Date(b.start));
        html += `<div class="sec"><h3>${dstr}</h3>`;
        if(!list.length){ html += `<div class="muted">予定なし</div>`; }
        else{
          html += `<ul>`;
          list.forEach(ev=>{
            const s=new Date(ev.start), e=new Date(ev.end||ev.start);
            const user=parseTitleUser(ev); const stf=parseTitleStaff(ev);
            const hh = String(s.getHours()).padStart(2,'0');
            html += `<li>${hh}時台：${user}、${s.toTimeString().slice(0,5)}〜${e.toTimeString().slice(0,5)}／スタッフ ${stf}</li>`;
          });
          html += `</ul>`;
        }
        html += `</div>`;
      });
      el.printView.innerHTML = html;
    }else{
      const startDay=new Date(staffBoardDate); startDay.setHours(0,0,0,0);
      const endDay=new Date(startDay); endDay.setDate(endDay.getDate()+1);
      const byStaff = {};
      (events||[]).forEach(ev=>{
        const s=new Date(ev.start);
        if(s>=startDay && s<endDay){
          const stf=parseTitleStaff(ev); (byStaff[stf]=byStaff[stf]||[]).push(ev);
        }
      });
      const names = Object.keys(byStaff).sort((a,b)=> a.localeCompare(b,'ja'));
      let html = `<h2>スタッフ別要約（${fmtDateLocal(startDay)}）</h2><div class="muted">※9:00〜18:00 のみ</div>`;
      if(!names.length){ html += `<div class="sec"><div class="muted">予定なし</div></div>`; }
      names.forEach(name=>{
        html += `<div class="sec"><h3>スタッフ ${name}</h3><ul>`;
        byStaff[name].sort((a,b)=> new Date(a.start)-new Date(b.start)).forEach(ev=>{
          const s=new Date(ev.start), e=new Date(ev.end||ev.start), user=parseTitleUser(ev);
          html += `<li>${s.toTimeString().slice(0,5)}〜${e.toTimeString().slice(0,5)}：${user}</li>`;
        });
        html += `</ul></div>`;
      });
      el.printView.innerHTML = html;
    }
  }
  function printCurrentView(){ buildPrintHTML(); window.print(); }

  // ====== ボタン類 ======
  el.btnResetWeek.onclick=()=>{
    const {monday,nextMonday}=getWeekRange(calendar.getDate());
    calendar.getEvents().forEach(ev=>{ if(ev.start>=monday && ev.start<nextMonday) ev.remove(); });
    persistEvents(); if(viewMode==='staffBoard') renderStaffBoard();
  };
  el.btnPrintCurrentA4.addEventListener('click', printCurrentView);

  // もっと見る（安定化）
  function setupCollapsible(listEl){
    if(!listEl) return;
    if(listEl.dataset.collapsibleInit === '1'){
      const btn = listEl.nextElementSibling;
      if(btn && btn.classList && btn.classList.contains('show-more-btn') && !btn.dataset.bound){
        btn.dataset.bound = '1';
        btn.addEventListener('click', ()=>{ listEl.classList.toggle('list-collapsed'); btn.textContent = listEl.classList.contains('list-collapsed') ? 'もっと見る' : '閉じる'; setTimeout(()=>calendar.updateSize(), 0); });
      }
      return;
    }
    listEl.dataset.collapsibleInit = '1';
    listEl.classList.add('list-collapsed');
    let btn = listEl.nextElementSibling;
    if(!(btn && btn.classList && btn.classList.contains('show-more-btn'))){
      btn = document.createElement('button'); btn.className='show-more-btn'; listEl.after(btn);
    }
    btn.textContent = 'もっと見る';
    btn.style.display = 'block';
    btn.dataset.bound = '1';
    btn.addEventListener('click', ()=>{ listEl.classList.toggle('list-collapsed'); btn.textContent = listEl.classList.contains('list-collapsed') ? 'もっと見る' : '閉じる'; setTimeout(()=>calendar.updateSize(), 0); });
    new MutationObserver(()=>{ btn.textContent = listEl.classList.contains('list-collapsed') ? 'もっと見る' : '閉じる'; }).observe(listEl, {childList:true});
  }

  // ヘッダー表示/非表示
  el.btnToggleHeader?.addEventListener('click',()=>{ document.body.classList.add('header-hidden'); });
  el.btnShowHeader?.addEventListener('click',()=>{ document.body.classList.remove('header-hidden'); });

  // サイドバー ON/OFF
  (function(){
    const btn = document.getElementById('btnToggleSidebar');
    if(!btn) return;
    btn.onclick = () => {
      document.body.classList.toggle('sidebar-collapsed');
      setTimeout(()=> calendar.updateSize(), 0);
      if(viewMode === 'staffBoard') renderStaffBoard();
    };
  })();

  el.btnViewToggle.addEventListener('click', ()=>{ switchViewMode(viewMode==='standard'?'staffBoard':'standard'); });

  // ====== データ変更系 ======
  const renderWeekdayChecks=(c)=>{ c.innerHTML=''; dayNamesJP.forEach(d=>{ const w=document.createElement('label'); w.className='chip'; w.innerHTML=`<input type="checkbox" value="${d}"> ${d}`; c.appendChild(w); }); };

  // 拠点保存
  el.btnSaveOffice?.addEventListener('click', async ()=>{
    const addr = (el.officeAddress.value||'').trim();
    office.address = addr;
    if(addr){
      const p = await geocodeAddress(addr);
      if(p){ office.lat=p.lat; office.lng=p.lng; } else { office.lat=null; office.lng=null; }
    }else{
      office.lat=null; office.lng=null;
    }
    save(); renderOffice();
    alert( (Number.isFinite(office.lat)&&Number.isFinite(office.lng)) ? '拠点の座標を保存しました' : '拠点を保存しました（座標は未取得）');
  });

  // 追加
  el.addStaff?.addEventListener('click',()=>{
    const name=el.staffName.value.trim(); if(!name) return alert('スタッフ名を入力');
    const type=el.staffType.value;
    staff.push({id:uid(),name,type,ngUserIds:[]});
    el.staffName.value=''; save(); renderAll(); calendar.refetchEvents(); if(viewMode==='staffBoard') renderStaffBoard();
  });

  el.addUser?.addEventListener('click', async ()=>{
    const name=el.userName.value.trim(); if(!name) return alert('利用者名を入力');
    const duration=parseInt(el.userDuration.value)||60;
    const address=(el.userAddress.value||'').trim();
    let lat=null,lng=null;
    if(address){
      const p = await geocodeAddress(address);
      if(p){ lat=p.lat; lng=p.lng; }
    }
    const id=uid();
    users.push({id,name,duration,address,lat,lng});
    el.userName.value=''; el.userAddress.value='';
    save(); renderAll(); if(viewMode==='staffBoard') renderStaffBoard();
  });

  el.addPattern?.addEventListener('click',()=>{
    const userId=el.patternUser.value; const time=el.patternTime.value;
    const days=[...el.patternDays.querySelectorAll('input:checked')].map(c=>c.value);
    if(!userId||days.length===0) return alert('利用者と曜日を選択');
    patterns.push({id:uid(),userId,time,days,active:true}); save(); renderPatterns();
  });

  el.addShift?.addEventListener('click',()=>{
    const staffId=el.shiftStaff.value;
    const days=[...el.shiftDays.querySelectorAll('input:checked')].map(c=>c.value);
    const s=el.shiftStart.value; const e=el.shiftEnd.value;
    if(!staffId||days.length===0) return alert('スタッフと曜日を選択');
    shifts.push({id:uid(),staffId,days,start:s,end:e}); save(); renderShifts();
  });

  // === NG：スタッフ選択で既存NGを自動チェック ===
  function refreshNGChecksForSelectedStaff(){
    const sid = el.ngStaff.value;
    const st=staff.find(x=>x.id===sid);
    const set = new Set(st?.ngUserIds||[]);
    el.ngUsers.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.checked = set.has(cb.value);
    });
  }
  el.ngStaff.addEventListener('change', refreshNGChecksForSelectedStaff);

  el.btnAddNG?.addEventListener('click',()=>{
    const sid=el.ngStaff.value; if(!sid) return;
    const st=staff.find(x=>x.id===sid); if(!st) return;
    const selected=[...el.ngUsers.querySelectorAll('input:checked')].map(i=>i.value);
    st.ngUserIds=[...selected]; // 全置換
    save(); renderStaff();
    alert('NGを保存しました');
  });

  // ==== 編集ダイアログ（利用者/スタッフ/パターン） ====
  function openUserEditor(userId){
    const u = users.find(x=>x.id===userId); if(!u) return;
    const overlay=document.createElement('div'); overlay.className='overlay';
    const box=document.createElement('div'); box.className='modal';
    const addr = u.address||'';
    const latStr = Number.isFinite(u.lat)?u.lat:'';
    const lngStr = Number.isFinite(u.lng)?u.lng:'';
    box.innerHTML=`
      <h3>利用者編集</h3>
      <label>氏名</label>
      <input id="euName" value="${u.name||''}">
      <div class="row">
        <div style="flex:1">
          <label>所要時間（分）</label>
          <select id="euDur">
            <option value="30" ${u.duration===30?'selected':''}>30</option>
            <option value="60" ${u.duration===60?'selected':''}>60</option>
            <option value="90" ${u.duration===90?'selected':''}>90</option>
          </select>
        </div>
      </div>
      <label>住所（任意）</label>
      <input id="euAddr" value="${addr}">
      <div class="row">
        <div style="flex:1"><label>緯度</label><input id="euLat" value="${latStr}" placeholder="自動取得/手入力可"></div>
        <div style="flex:1"><label>経度</label><input id="euLng" value="${lngStr}" placeholder="自動取得/手入力可"></div>
      </div>
      <div class="actions">
        <button id="euGeocode" class="btn">住所をジオコーディング</button>
        <button id="euSave" class="btn primary">保存</button>
        <button id="euClose" class="btn ghost">閉じる</button>
      </div>`;
    document.body.appendChild(overlay); document.body.appendChild(box);
    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) close(); });
    function close(){ overlay.remove(); box.remove(); }
    document.getElementById('euClose').onclick=close;
    document.getElementById('euGeocode').onclick=async ()=>{
      const ad = document.getElementById('euAddr').value.trim();
      if(!ad) return alert('住所を入力してください');
      const p = await geocodeAddress(ad);
      if(p){
        document.getElementById('euLat').value = p.lat;
        document.getElementById('euLng').value = p.lng;
        alert('座標を取得しました');
      }else{
        alert('座標を取得できませんでした');
      }
    };
    document.getElementById('euSave').onclick=()=>{
      u.name = document.getElementById('euName').value.trim()||u.name;
      u.duration = parseInt(document.getElementById('euDur').value)||u.duration;
      u.address = document.getElementById('euAddr').value.trim();
      const lt = parseFloat(document.getElementById('euLat').value);
      const lg = parseFloat(document.getElementById('euLng').value);
      u.lat = Number.isFinite(lt)?lt:null;
      u.lng = Number.isFinite(lg)?lg:null;
      save(); renderAll(); refreshNGChecksForSelectedStaff(); close();
    };
  }

  function openStaffEditor(staffId){
    const s = staff.find(x=>x.id===staffId); if(!s) return;
    const overlay=document.createElement('div'); overlay.className='overlay';
    const box=document.createElement('div'); box.className='modal';
    box.innerHTML=`
      <h3>スタッフ編集</h3>
      <label>氏名</label>
      <input id="esName" value="${s.name||''}">
      <label>雇用区分</label>
      <select id="esType">
        <option value="FT" ${s.type==='FT'?'selected':''}>常勤</option>
        <option value="PT" ${s.type==='PT'?'selected':''}>非常勤</option>
      </select>
      <div class="actions">
        <button id="esSave" class="btn primary">保存</button>
        <button id="esClose" class="btn ghost">閉じる</button>
      </div>`;
    document.body.appendChild(overlay); document.body.appendChild(box);
    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) close(); });
    function close(){ overlay.remove(); box.remove(); }
    document.getElementById('esClose').onclick=close;

    document.getElementById('esSave').onclick=()=>{
      s.name = document.getElementById('esName').value.trim() || s.name;
      s.type = document.getElementById('esType').value;
      save(); renderAll(); calendar.refetchEvents(); if(viewMode==='staffBoard') renderStaffBoard(); close();
    };
  }

  function openPatternEditor(patternId){
    const p = patterns.find(x=>x.id===patternId); if(!p) return;
    const usersSorted=[...users].sort(sortByName);
    const overlay=document.createElement('div'); overlay.className='overlay';
    const box=document.createElement('div'); box.className='modal';
    const options = usersSorted.map(u=>`<option value="${u.id}" ${u.id===p.userId?'selected':''}>${u.name}</option>`).join('');
    const dayChip = (d)=>`<label class="chip"><input type="checkbox" value="${d}" ${p.days?.includes(d)?'checked':''}> ${d}</label>`;
    box.innerHTML=`
      <h3>パターン編集</h3>
      <label>利用者</label>
      <select id="epUser">${options}</select>
      <label>曜日</label>
      <div id="epDays" class="row">${['月','火','水','木','金','土','日'].map(dayChip).join('')}</div>
      <label>開始時刻</label>
      <input id="epTime" type="time" value="${p.time||'09:00'}">
      <div class="actions">
        <button id="epSave" class="btn primary">保存</button>
        <button id="epClose" class="btn ghost">閉じる</button>
      </div>
    `;
    document.body.appendChild(overlay); document.body.appendChild(box);
    overlay.addEventListener('click',(e)=>{ if(e.target===overlay) close(); });
    function close(){ overlay.remove(); box.remove(); }
    document.getElementById('epClose').onclick=close;
    document.getElementById('epSave').onclick=()=>{
      p.userId = document.getElementById('epUser').value || p.userId;
      p.time   = document.getElementById('epTime').value || p.time;
      p.days   = [...document.querySelectorAll('#epDays input:checked')].map(c=>c.value);
      save(); renderPatterns(); close();
    };
  }

  // 削除/編集（委譲）
  document.body.addEventListener('click',(e)=>{
    const t=e.target; if(!(t instanceof HTMLElement)) return;
    if(t.classList.contains('delStaff')){
      const id=t.dataset.id; const rm=staff.find(x=>x.id===id)?.name;
      staff=staff.filter(x=>x.id!==id);
      events=events.filter(ev=> parseTitleStaff(ev)!==rm );
      save(); renderAll(); calendar.refetchEvents(); if(viewMode==='staffBoard') renderStaffBoard();
    }
    if(t.classList.contains('editStaff')){
      const id=t.dataset.id; openStaffEditor(id);
    }
    if(t.classList.contains('delUser')){
      const id=t.dataset.id; const uname=users.find(x=>x.id===id)?.name;
      users=users.filter(x=>x.id!==id);
      patterns=patterns.filter(p=>p.userId!==id);
      events=events.filter(ev=> !uname || !ev.title?.startsWith(`${uname}（`));
      staff = staff.map(s=>({...s, ngUserIds:(s.ngUserIds||[]).filter(x=>x!==id)}));
      save(); renderAll(); calendar.refetchEvents(); if(viewMode==='staffBoard') renderStaffBoard();
    }
    if(t.classList.contains('editUser')){
      const id=t.dataset.id; openUserEditor(id);
    }
    if(t.classList.contains('delPattern')){
      const id=t.dataset.id; patterns=patterns.filter(p=>p.id!==id); save(); renderPatterns();
    }
    if(t.classList.contains('editPattern')){
      const id=t.dataset.id; openPatternEditor(id);
    }
    if(t.classList.contains('delShift')){ const id=t.dataset.id; shifts=shifts.filter(p=>p.id!==id); save(); renderShifts(); }
  });

  // ====== Init ======
  load();
  const renderWeekdayChecksInit=(c)=>{ c.innerHTML=''; dayNamesJP.forEach(d=>{ const w=document.createElement('label'); w.className='chip'; w.innerHTML=`<input type="checkbox" value="${d}"> ${d}`; c.appendChild(w); }); };
  renderWeekdayChecksInit(el.patternDays);
  renderWeekdayChecksInit(el.shiftDays);
  renderAll();
  ['staffList','userList','patternList','shiftList'].forEach(id=> setupCollapsible(document.getElementById(id)));
  calendar.render();

  // 自動割当ボタン
  el.btnAutoAssignBottom.addEventListener('click',autoAssignWeek);
});
</script>
</body>
</html>