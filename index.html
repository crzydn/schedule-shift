<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>訪問看護スケジュール管理（最終版）</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <style>
    :root{
      --brand:#2F7DF6; --brand-2:#6BB6FF; --bg:#F6FAFF; --panel:#FFFFFF; --line:#D9E7FB;
      --text:#0C1B2A; --muted:#6E7F95; --chip:#EEF6FF; --danger:#E05252; --ok:#2FBF71;
      --event-border:rgba(255,255,255,.96);
      --modal-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    body{font-family:'Noto Sans JP',system-ui,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
    header h1{margin:0;font-size:1.06rem;letter-spacing:.2px}
    header .btns button{margin-left:6px;padding:8px 12px;border-radius:10px;border:1px solid #fff;background:rgba(255,255,255,.12);color:#fff;font-weight:800;cursor:pointer}
    header .btns button:hover{background:rgba(255,255,255,.2)}
    .layout{display:grid;grid-template-columns:380px 1fr;gap:12px;height:calc(100vh - 58px);padding:12px;box-sizing:border-box}
    aside,main{background:var(--panel);border-radius:14px;overflow:auto;border:1px solid var(--line)}
    aside{padding:14px;position:relative}
    main{padding:6px}
    h3{margin:8px 0;font-size:1rem}
    label{display:block;margin:6px 0 4px;font-weight:700}
    input,select,button{width:100%;padding:11px;border:1px solid var(--line);border-radius:10px;box-sizing:border-box;font-size:1rem}
    input::placeholder{color:#9fb4cf}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;display:flex;align-items:center;gap:8px}
    #calendar{min-height:78vh}
    .sticky-bottom{position:sticky;bottom:0;background:#fff;padding-top:8px;border-top:1px solid #e9f1ff}
    .sticky-bottom .primary{background:var(--brand);color:#fff;border-color:var(--brand);font-weight:800}
    @media (max-width:768px){.layout{grid-template-columns:1fr;height:auto}aside{order:2}main{order:1}}

    /* FullCalendar 調整（画面） */
    .fc .fc-toolbar-title{font-weight:800}
    .fc .fc-button{border-radius:10px !important}
    .fc .fc-timegrid-slot{height:46px}
    .fc-v-event{border:2px solid var(--event-border);border-radius:12px;padding:4px 6px;font-weight:800;overflow:hidden;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.12);opacity:.98}
    .fc-v-event:hover{filter:brightness(1.04);transform:translateY(-1px);transition:.15s}

    /* モーダル（中央固定・色味復元） */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:999}
    .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:14px;box-shadow:var(--modal-shadow);padding:16px;z-index:1000;min-width:360px;max-width:92vw;border:1px solid var(--line)}
    .modal h3{margin-top:0}
    .actions{display:flex;gap:8px;margin-top:10px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);cursor:pointer;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#fff;border-color:var(--brand)}
    .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .btn.ghost{background:#fff;color:var(--brand);border-color:var(--brand)}

    /* もっと見る（常にボタン表示・初期折りたたみ） */
    .list-collapsed{ max-height: 140px; overflow: hidden; position: relative; }
    .list-collapsed::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:48px;
      background: linear-gradient(to bottom, rgba(255,255,255,0), var(--panel)); pointer-events:none;
    }
    .show-more-btn{
      margin-top:6px; width:100%; background:var(--chip); border:1px solid var(--line);
      border-radius:10px; padding:8px 10px; font-weight:800; color:var(--text); cursor:pointer;
      display:block;
    }
    .show-more-btn:hover{ filter:brightness(1.03); }

    /* 横幅最大化（余白削減は標準ON） */
    body.sidebar-collapsed .layout{ grid-template-columns: 1fr !important; }
    body.sidebar-collapsed aside{ display: none !important; }
    body.edge-to-edge .layout{ padding: 0 !important; }
    body.edge-to-edge main{ padding: 0 !important; border: none !important; border-radius: 0 !important; }
    body.edge-to-edge #calendar{ min-height: 85vh; }
    body.sidebar-collapsed .fc .fc-timegrid-axis-cushion{ font-size:11px; }
    body.sidebar-collapsed .fc .fc-col-header-cell-cushion{ font-size:12px; }

    /* ヘッダー非表示モード（復帰ボタンは残す） */
    body.header-hidden header{ display:none; }
    #btnShowHeader{
      position:fixed; top:8px; left:8px; z-index:1100;
      padding:8px 12px; border-radius:12px; border:1px solid var(--brand);
      background:#fff; color:var(--brand); font-weight:800; cursor:pointer;
      box-shadow:0 3px 12px rgba(0,0,0,.15);
    }
    body:not(.header-hidden) #btnShowHeader{ display:none; }

    /* ========= 印刷（現在ビューをそのまま・9〜18時・高コントラスト） ========= */
    @media print {
      html, body, #calendar, .fc, .fc * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      html, body { height:auto; }
      header{display:none}
      .layout{grid-template-columns:1fr}
      aside{display:none}
      main{border:none}

      .fc, .fc .fc-view-harness, .fc .fc-scrollgrid,
      .fc .fc-scroller-harness, .fc .fc-scroller {
        height:auto !important; overflow:visible !important;
      }

      /* 9:00〜18:00 だけ出力（それ以外のスロットを隠す） */
      .fc-timegrid-slot[data-time^="00:"],
      .fc-timegrid-slot[data-time^="01:"],
      .fc-timegrid-slot[data-time^="02:"],
      .fc-timegrid-slot[data-time^="03:"],
      .fc-timegrid-slot[data-time^="04:"],
      .fc-timegrid-slot[data-time^="05:"],
      .fc-timegrid-slot[data-time^="06:"],
      .fc-timegrid-slot[data-time^="07:"],
      .fc-timegrid-slot[data-time^="08:"],
      .fc-timegrid-slot[data-time^="18:"],
      .fc-timegrid-slot[data-time^="19:"],
      .fc-timegrid-slot[data-time^="20:"],
      .fc-timegrid-slot[data-time^="21:"],
      .fc-timegrid-slot[data-time^="22:"],
      .fc-timegrid-slot[data-time^="23:"]
      { display:none !important; }

      /* 罫線/文字を濃くして視認性UP */
      .fc-theme-standard td, .fc-theme-standard th{ border-color:#999 !important; }
      .fc .fc-timegrid-slot-lane{ border-color:#bbb !important; }
      .fc .fc-col-header-cell{ border-bottom:2px solid #000 !important; }
      .fc .fc-col-header-cell-cushion{ color:#000 !important; font-weight:800 !important; font-size:11.5px !important; padding:3px 0 !important; }
      .fc .fc-timegrid-axis-cushion{ color:#000 !important; font-weight:700 !important; font-size:11px !important; padding:0 !important; }
      .fc .fc-day-today{ background:transparent !important; }
      .fc .fc-timegrid-now-indicator-container{ display:none !important; }

      /* イベント：白地＋黒太枠＋太字＝確実に読める */
      .fc .fc-timegrid-event, .fc .fc-v-event, .fc .fc-event{
        background:#fff !important;
        border:2px solid #000 !important;
        color:#000 !important;
        box-shadow:none !important;
        transform:none !important;
        opacity:1 !important;
        border-radius:8px !important;
        padding:2px 4px !important;
      }
      .fc .fc-event-time{ font-weight:900 !important; }
      .fc .fc-event-title{ font-weight:800 !important; }
      .fc .fc-event-main{ white-space:normal !important; }

      /* 改ページ抑制 */
      .fc-timegrid-slots table, .fc-timegrid-slots tr, .fc-timegrid-slots td,
      .fc-timegrid-body, .fc-scrollgrid, .fc-timegrid-cols, .fc-timegrid-axis, .fc-timegrid-slot{
        break-inside:avoid; page-break-inside:avoid;
      }

      /* All-day は印刷でも非表示（カレンダー側もallDaySlot:false） */
      .fc .fc-timegrid-all-day{ display:none !important; }
    }

    /* 画面側ボタンの配色（印刷には影響させない） */
    @media screen {
      aside .row > button{
        background:var(--brand); color:#fff; border-color:var(--brand);
        font-weight:800; box-shadow:0 1px 4px rgba(47,125,246,.18);
      }
      .chip > button{
        background:var(--danger); color:#fff; border-color:var(--danger);
        padding:6px 10px; border-radius:999px; font-weight:800;
      }
      .sticky-bottom .primary{
        background:linear-gradient(180deg,var(--brand-2),var(--brand));
        border-color:var(--brand); color:#fff;
        box-shadow:0 2px 8px rgba(47,125,246,.28);
      }
    }
  </style>
</head>

<body class="edge-to-edge">
  <!-- ヘッダー再表示専用ボタン（常時DOMに存在） -->
  <button id="btnShowHeader">ヘッダー表示</button>

  <header>
    <h1>訪問看護スケジュール管理</h1>
    <div class="btns">
      <button id="btnResetWeek">今週分を消去</button>
      <button id="btnPrintCurrentA4">A4印刷(画面表示)</button>
      <button id="btnExportExcel">Excel出力</button>
      <button id="btnToggleSidebar">サイドバー表示/非表示</button>
      <button id="btnToggleHeader">ヘッダー非表示</button>
    </div>
  </header>

  <div class="layout">
    <aside>
      <h3>スタッフ登録</h3>
      <div class="row">
        <input id="staffName" placeholder="氏名（例：佐藤）" />
        <select id="staffType" style="max-width:120px">
          <option value="FT">常勤</option><option value="PT">非常勤</option>
        </select>
      </div>
      <div class="row"><button id="addStaff">追加</button></div>
      <div id="staffList" class="chips"></div>

      <h3>出勤パターン（複数帯OK）</h3>
      <label>スタッフ</label><select id="shiftStaff"></select>
      <label>曜日</label><div id="shiftDays" class="row"></div>
      <label>勤務時間</label>
      <div class="row">
        <input id="shiftStart" type="time" value="09:00" style="flex:1">
        <input id="shiftEnd" type="time" value="18:00" style="flex:1">
      </div>
      <div class="row"><button id="addShift">出勤パターン追加</button></div>
      <div id="shiftList" class="chips"></div>

      <h3>利用者登録</h3>
      <div class="row">
        <input id="userName" placeholder="利用者氏名（例：田中）" />
        <select id="userDuration" style="max-width:120px"><option value="60">60分</option><option value="30">30分</option></select>
      </div>
      <div class="row"><button id="addUser">追加</button></div>
      <div id="userList" class="chips"></div>

      <h3>基本訪問パターン</h3>
      <label>利用者</label><select id="patternUser"></select>
      <label>曜日</label><div id="patternDays" class="row"></div>
      <label>開始時刻</label><input id="patternTime" type="time" value="09:00" />
      <div class="row"><button id="addPattern">パターン追加</button></div>
      <div id="patternList" class="chips"></div>

      <!-- ▼ NG設定（複数選択対応） -->
      <h3>NG設定（スタッフ別）</h3>
      <label>スタッフ</label>
      <select id="ngStaff"></select>
      <label>NGにする利用者（複数選択可）</label>
      <div id="ngUsers" class="row" style="max-height:140px; overflow:auto; border:1px dashed var(--line); padding:8px; border-radius:10px"></div>
      <div class="row">
        <button id="btnAddNG">NG追加</button>
      </div>

      <div class="sticky-bottom">
        <button id="btnAutoAssignBottom" class="primary">自動割当（表示週）</button>
      </div>
    </aside>

    <main>
      <div id="calendar"></div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded',()=>{
    // ====== Utils ======
    const STORAGE_KEY='vk_data_final_v7';
    const dayNames=['月','火','水','木','金','土','日'];
    const fmtDateLocal=(d)=>{const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;};
    const addMinStr=(hhmm, mins)=>{const [h,m]=hhmm.split(':').map(Number);const dt=new Date();dt.setHours(h);dt.setMinutes(m+mins);return dt.toTimeString().slice(0,5)};
    const ceilTo15=(date)=>{const ms=15*60*1000;return new Date(Math.ceil(date.getTime()/ms)*ms)};
    const uid=()=>Math.random().toString(36).slice(2,9);
    const isMobile=()=>window.matchMedia('(max-width:768px)').matches;
    const getWeekRange=(base)=>{const monday=new Date(base);monday.setDate(base.getDate()-((base.getDay()+6)%7));monday.setHours(0,0,0,0);return {monday,nextMonday:new Date(monday.getTime()+7*24*60*60*1000)}};

    // ====== State ======
    let staff=[], users=[], patterns=[], shifts=[], events=[];
    let skippedAssignments=[]; // 見送りリスト {date, start, end, userId, reason}

    // ====== DOM refs ======
    const el={
      staffName:document.getElementById('staffName'), staffType:document.getElementById('staffType'), addStaff:document.getElementById('addStaff'), staffList:document.getElementById('staffList'),
      userName:document.getElementById('userName'), userDuration:document.getElementById('userDuration'), addUser:document.getElementById('addUser'), userList:document.getElementById('userList'),
      patternUser:document.getElementById('patternUser'), patternDays:document.getElementById('patternDays'), patternTime:document.getElementById('patternTime'), addPattern:document.getElementById('addPattern'), patternList:document.getElementById('patternList'),
      shiftStaff:document.getElementById('shiftStaff'), shiftDays:document.getElementById('shiftDays'), shiftStart:document.getElementById('shiftStart'), shiftEnd:document.getElementById('shiftEnd'), addShift:document.getElementById('addShift'), shiftList:document.getElementById('shiftList'),
      btnAutoAssignBottom:document.getElementById('btnAutoAssignBottom'), btnResetWeek:document.getElementById('btnResetWeek'),
      btnExportExcel:document.getElementById('btnExportExcel'),
      calendarHost:document.getElementById('calendar'),
      btnPrintCurrentA4:document.getElementById('btnPrintCurrentA4'),
      btnToggleSidebar:document.getElementById('btnToggleSidebar'),
      btnToggleHeader:document.getElementById('btnToggleHeader'),
      btnShowHeader:document.getElementById('btnShowHeader'),
      // NG UI
      ngStaff:document.getElementById('ngStaff'),
      ngUsers:document.getElementById('ngUsers'),
      btnAddNG:document.getElementById('btnAddNG')
    };

    // ====== Storage ======
    const save=()=>localStorage.setItem(STORAGE_KEY, JSON.stringify({staff,users,patterns,shifts,events}));
    const load=()=>{try{const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; const d=JSON.parse(raw);
      staff=(d.staff||[]).map(s=>({...s, ngUserIds: s.ngUserIds||[]})); users=d.users||[]; patterns=d.patterns||[]; shifts=d.shifts||[]; events=d.events||[];
    }catch(e){console.error('load failed',e)}};

    // ====== Render helpers ======
    const renderWeekdayChecks=(c)=>{ c.innerHTML=''; dayNames.forEach(d=>{ const w=document.createElement('label'); w.className='chip'; w.innerHTML=`<input type="checkbox" value="${d}"> ${d}`; c.appendChild(w); }); };
    const hydrateSelects=()=>{
      // pattern/user select
      el.patternUser.innerHTML=''; users.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.name; el.patternUser.appendChild(o); });
      // shift/staff select
      el.shiftStaff.innerHTML=''; staff.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; el.shiftStaff.appendChild(o); });
      // NG: staff
      el.ngStaff.innerHTML=''; staff.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.name}（${s.type==='PT'?'非常勤':'常勤'}）`; el.ngStaff.appendChild(o); });
      // NG: users (チェックボックス)
      el.ngUsers.innerHTML='';
      users.forEach(u=>{
        const id=`ngu_${u.id}`;
        const lab=document.createElement('label'); lab.className='chip';
        lab.innerHTML=`<input type="checkbox" value="${u.id}" id="${id}"> ${u.name}`;
        el.ngUsers.appendChild(lab);
      });
    };
    const renderStaff=()=>{
      el.staffList.innerHTML='';
      staff.forEach(s=>{
        const ngNames=(s.ngUserIds||[]).map(id=>users.find(u=>u.id===id)?.name).filter(Boolean);
        const ngText=ngNames.length? `｜NG: ${ngNames.join('・')}` : '';
        el.staffList.innerHTML+=`<span class='chip'>${s.name}（${s.type==='PT'?'非常勤':'常勤'}） ${ngText} <button class='delStaff' data-id='${s.id}'>削除</button></span>`;
      });
    };
    const renderUsers=()=>{ el.userList.innerHTML=''; users.forEach(u=>{ el.userList.innerHTML+=`<span class='chip'>${u.name}（${u.duration}分） <button class='delUser' data-id='${u.id}'>削除</button></span>`; }); };
    const renderPatterns=()=>{ el.patternList.innerHTML=''; patterns.forEach(p=>{ const u=users.find(x=>x.id===p.userId); el.patternList.innerHTML+=`<span class='chip'>${u?u.name:'不明'}：${(p.days||[]).join('・')} ${p.time||''} <button class='delPattern' data-id='${p.id}'>削除</button></span>`; }); };
    const renderShifts=()=>{ el.shiftList.innerHTML=''; shifts.forEach(s=>{ const stf=staff.find(x=>x.id===s.staffId); el.shiftList.innerHTML+=`<span class='chip'>${stf?stf.name:'不明'}：${s.days.join('・')} ${s.start}〜${s.end} <button class='delShift' data-id='${s.id}'>削除</button></span>`; }); };
    const renderAll=()=>{ hydrateSelects(); renderStaff(); renderUsers(); renderPatterns(); renderShifts(); };

    // ====== Mutations ======
    el.addStaff?.addEventListener('click',()=>{
      const name=el.staffName.value.trim(); if(!name) return alert('スタッフ名を入力');
      const type=el.staffType.value;
      staff.push({id:uid(),name,type,ngUserIds:[]});
      el.staffName.value=''; save(); renderAll(); calendar.refetchEvents();
    });
    el.addUser?.addEventListener('click',()=>{
      const name=el.userName.value.trim(); if(!name) return alert('利用者名を入力');
      const duration=parseInt(el.userDuration.value)||30;
      users.push({id:uid(),name,duration}); el.userName.value=''; save(); renderAll();
    });
    el.addPattern?.addEventListener('click',()=>{
      const userId=el.patternUser.value; const time=el.patternTime.value;
      const days=[...el.patternDays.querySelectorAll('input:checked')].map(c=>c.value);
      if(!userId||days.length===0) return alert('利用者と曜日を選択');
      patterns.push({id:uid(),userId,time,days,active:true}); save(); renderPatterns();
    });
    el.addShift?.addEventListener('click',()=>{
      const staffId=el.shiftStaff.value;
      const days=[...el.shiftDays.querySelectorAll('input:checked')].map(c=>c.value);
      const s=el.shiftStart.value; const e=el.shiftEnd.value;
      if(!staffId||days.length===0) return alert('スタッフと曜日を選択');
      shifts.push({id:uid(),staffId,days,start:s,end:e}); save(); renderShifts();
    });

    // NG追加（複数選択）
    el.btnAddNG?.addEventListener('click',()=>{
      const sid=el.ngStaff.value; if(!sid) return;
      const st=staff.find(x=>x.id===sid); if(!st) return;
      const selected=[...el.ngUsers.querySelectorAll('input:checked')].map(i=>i.value);
      const set=new Set(st.ngUserIds||[]);
      selected.forEach(id=>set.add(id));
      st.ngUserIds=[...set];
      save(); renderStaff();
      // チェックを残すと次の追加が分かりにくいので外す
      el.ngUsers.querySelectorAll('input:checked').forEach(i=> i.checked=false);
      alert('NGを追加しました');
    });

    // 削除（委譲）
    document.body.addEventListener('click',(e)=>{
      const t=e.target; if(!(t instanceof HTMLElement)) return;
      if(t.classList.contains('delStaff')){
        const id=t.dataset.id; const rm=staff.find(x=>x.id===id)?.name;
        staff=staff.filter(x=>x.id!==id);
        events=events.filter(ev=>{ const m=/（(.*)）$/.exec(ev.title||''); return !m || m[1]!==rm; });
        save(); renderAll(); calendar.refetchEvents();
      }
      if(t.classList.contains('delUser')){
        const id=t.dataset.id; const uname=users.find(x=>x.id===id)?.name;
        users=users.filter(x=>x.id!==id);
        patterns=patterns.filter(p=>p.userId!==id);
        events=events.filter(ev=> !uname || !ev.title?.startsWith(`${uname}（`));
        staff = staff.map(s=>({...s, ngUserIds:(s.ngUserIds||[]).filter(x=>x!==id)}));
        save(); renderAll(); calendar.refetchEvents();
      }
      if(t.classList.contains('delPattern')){ const id=t.dataset.id; patterns=patterns.filter(p=>p.id!==id); save(); renderPatterns(); }
      if(t.classList.contains('delShift')){ const id=t.dataset.id; shifts=shifts.filter(p=>p.id!==id); save(); renderShifts(); }
    });

    // ====== Calendar ======
    const calendar=new FullCalendar.Calendar(el.calendarHost,{
      timeZone:'local',
      headerToolbar: isMobile()? {left:'prev,next today',center:'title',right:'timeGridDay'} : {left:'prev,next today',center:'title',right:'timeGridWeek,timeGridDay'},
      initialView: isMobile()? 'timeGridDay' : 'timeGridWeek',
      firstDay:1, locale:'ja', height:'auto',
      slotMinTime:'09:00', slotMaxTime:'18:00',   // 18時まで。19時台は画面でも出さない
      expandRows:true, stickyHeaderDates:true,
      editable:true,
      eventOverlap:true, slotEventOverlap:true, nowIndicator:true,
      slotDuration:'00:15:00', snapDuration:'00:15:00',
      allDaySlot:false,
      events:(info,success)=>{ success((events||[]).map(e=>({...e}))); },
      eventDidMount:(info)=>{
        const m=/（(.*)）$/.exec(info.event.title||''); const staffName=m?m[1]:'';
        let h=0; for(let i=0;i<staffName.length;i++) h=(h*31+staffName.charCodeAt(i))>>>0; const hue=h%360;
        info.el.style.background=`hsl(${hue} 85% 82%)`;
        info.el.style.borderColor='var(--event-border)';
      },
      eventDrop:(info)=>{ const s=ceilTo15(info.event.start); const e=ceilTo15(info.event.end); info.event.setDates(s,e); persistEvents(); },
      eventResize:(info)=>{ const s=ceilTo15(info.event.start); const e=ceilTo15(info.event.end); info.event.setDates(s,e); persistEvents(); },
      dateClick:(info)=>{
        const usr=prompt('利用者名'); if(!usr) return; const stf=prompt('スタッフ名'); if(!stf) return;
        const s=new Date(info.dateStr); const e=new Date(s.getTime()+60*60000);
        events.push({title:`${usr}（${stf}）`,start:s.toISOString(),end:e.toISOString()});
        save(); calendar.refetchEvents();
      },
      eventClick:(info)=>{ showEventPreview(info.event); }
    });

    function persistEvents(){
      events = calendar.getEvents().map(ev=>({
        title:ev.title, start:ev.start.toISOString(), end:ev.end.toISOString(), extendedProps: ev.extendedProps||{}
      }));
      save();
    }

    // ==== イベント プレビュー ====
    function showEventPreview(event){
      const overlay=document.createElement('div'); overlay.className='overlay';
      const box=document.createElement('div'); box.className='modal';
      const m=/^(.*)（(.*)）$/.exec(event.title||'');
      const user=m?m[1]:''; const staffName=m?m[2]:'';
      const start=event.start; const end=event.end||new Date(start.getTime()+30*60000);
      const dur=Math.round((end-start)/60000);
      const startStr=start.toTimeString().slice(0,5);

      box.innerHTML = `
        <h3>訪問プレビュー</h3>
        <div><strong>スタッフ：</strong>${staffName||'(未設定)'}</div>
        <div><strong>利用者：</strong>${user||'(未設定)'}</div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1">
            <label>開始</label>
            <input id="pvStart" type="time" value="${startStr}">
          </div>
          <div style="flex:1">
            <label>時間（分）</label>
            <select id="pvDur"><option value="30" ${dur===30?'selected':''}>30</option><option value="60" ${dur===60?'selected':''}>60</option></select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div style="flex:1">
            <label>スタッフ</label>
            <select id="pvStaff">${[...new Set(staff.map(s=>s.name))].map(n=>`<option ${n===staffName?'selected':''}>${n}</option>`).join('')}</select>
          </div>
          <div style="flex:1">
            <label>利用者</label>
            <select id="pvUser">${[...new Set(users.map(u=>u.name))].map(n=>`<option ${n===user?'selected':''}>${n}</option>`).join('')}</select>
          </div>
        </div>
        <div class="actions">
          <button id="pvSave" class="btn primary">保存</button>
          <button id="pvDelete" class="btn danger">削除</button>
          <button id="pvClose" class="btn ghost">閉じる</button>
        </div>
      `;
      document.body.appendChild(overlay); document.body.appendChild(box);
      const close=()=>{ overlay.remove(); box.remove(); };
      document.getElementById('pvClose').onclick=close;
      document.getElementById('pvDelete').onclick=()=>{ if(confirm('削除しますか？')){ event.remove(); persistEvents(); close(); } };
      document.getElementById('pvSave').onclick=()=>{
        const st = document.getElementById('pvStart').value || '09:00';
        const dur = parseInt(document.getElementById('pvDur').value)||60;
        const stf = document.getElementById('pvStaff').value || staffName;
        const usr = document.getElementById('pvUser').value || user;
        const day = `${event.start.getFullYear()}-${String(event.start.getMonth()+1).padStart(2,'0')}-${String(event.start.getDate()).padStart(2,'0')}`;
        const endStr = (function(hhmm,m){ const [h,mi]=hhmm.split(':').map(Number); const d=new Date(); d.setHours(h); d.setMinutes(mi+m); return d.toTimeString().slice(0,5);} )(st,dur);
        event.setProp('title', `${usr}（${stf}）`);
        event.setStart(`${day}T${st}:00`);
        event.setEnd(`${day}T${endStr}:00`);
        persistEvents(); close();
      };
    }

    // ====== 自動割当（常勤のみ均等化・NG考慮・見送り収集） ======
    function countAssignedForWeek(staffName, monday, nextMonday){
      let c=0;
      (events||[]).forEach(ev=>{
        const m=/（(.*)）$/.exec(ev.title||''); const stf=m?m[1]:'';
        if(stf===staffName){ const s=new Date(ev.start); if(s>=monday && s<nextMonday) c++; }
      });
      return c;
    }

    function autoAssignWeek(){
      if(staff.length===0){ alert('スタッフを登録してください'); return; }
      if(users.length===0){ alert('利用者を登録してください'); return; }
      const active = patterns.filter(p => p.active !== false);
      if(active.length===0){ alert('有効な基本訪問パターンがありません'); return; }

      const rng = getWeekRange(calendar.getDate());
      const monday = rng.monday; const nextMonday = rng.nextMonday;
      const inWeek = (iso)=>{ const d=new Date(iso); return d>=monday && d<nextMonday; };

      // 今週分を初期化（上書き型）
      events = (events||[]).filter(ev=> !inWeek(ev.start));
      skippedAssignments = [];

      const hasShiftLocal = (stfId, dayLabel, startStr, endStr)=>{
        const sh = shifts.filter(x=>x.staffId===stfId && x.days.includes(dayLabel));
        return sh.some(x=> x.start<=startStr && x.end>=endStr );
      };

      const placeable=(cand, dayLabel, st, en, userId)=>{
        const stfName=cand.name;
        // NG判定
        const isNG=(cand.ngUserIds||[]).includes(userId);
        if(isNG) return false;
        // 時間帯重複判定（名前で紐付け）
        const startISO = st; const endISO = en;
        const ns=new Date(startISO), ne=new Date(endISO);
        const clash = (events||[]).some(ev=>{
          const m=/（(.*)）$/.exec(ev.title||''); const name=m?m[1]:'';
          if(name!==stfName) return false;
          const s=new Date(ev.start), e=new Date(ev.end||ev.start);
          return !(e<=ns || s>=ne);
        });
        return !clash;
      };

      let placed=0;

      for(const p of active){
        const u = users.find(x=>x.id===p.userId); if(!u){ skippedAssignments.push({reason:'利用者不明', userId:p.userId}); continue; }
        for(const d of (p.days||[])){
          const idx = dayNames.indexOf(d); if(idx<0){ skippedAssignments.push({reason:'曜日不正', userId:u.id}); continue; }
          const day = new Date(monday); day.setDate(monday.getDate()+idx);
          const st = p.time; const en = addMinStr(st, u.duration);

          const startISO = `${fmtDateLocal(day)}T${st}:00`;
          const endISO   = `${fmtDateLocal(day)}T${en}:00`;

          // 候補抽出（シフト一致 & NG回避）
          const candidates = staff.filter(s=> hasShiftLocal(s.id,d,st,en));

          // 常勤のみで均等化
          const ft = candidates.filter(c=> c.type==='FT' && !((c.ngUserIds||[]).includes(u.id)));
          let picked=null;
          if(ft.length){
            // 今週の担当件数が少ない順
            const withCount = ft.map(c=>({c, cnt: countAssignedForWeek(c.name,monday,nextMonday)}))
                                .sort((a,b)=> a.cnt-b.cnt || a.c.name.localeCompare(b.c.name));
            for(const item of withCount){
              if(placeable(item.c,d,startISO,endISO,u.id)){ picked=item.c; break; }
            }
          }
          // FTで置けない場合のみ PTへフォールバック（均等化はしない）
          if(!picked){
            const pt = candidates.filter(c=> c.type!=='FT' && !((c.ngUserIds||[]).includes(u.id)));
            for(const cand of pt){
              if(placeable(cand,d,startISO,endISO,u.id)){ picked=cand; break; }
            }
          }
          if (!picked) {
            skippedAssignments.push({
              reason:'割当不可（NG/重複/不在）',
              userId:u.id, date:fmtDateLocal(day), start:st, end:en
            });
            continue;
          }

          events.push({ title:`${u.name}（${picked.name}）`, start:startISO, end:endISO });
          placed++;
        }
      }

      save(); calendar.refetchEvents();
      showSkippedModal(); // 見送りをモーダルで表示・編集
      alert(`自動割当 完了：配置 ${placed} 件 / 見送り ${skippedAssignments.length} 件（表示週）`);
    }

    // ====== 見送りリスト モーダル（編集＆配置） ======
    function showSkippedModal(){
      const overlay=document.createElement('div'); overlay.className='overlay';
      const box=document.createElement('div'); box.className='modal';
      box.style.minWidth='600px';
      const rows = skippedAssignments.map((s,idx)=>{
        const uname = users.find(u=>u.id===s.userId)?.name || '(不明)';
        const date = s.date||'(日付)';
        const st = s.start||'09:00';
        const en = s.end||'10:00';
        // 候補スタッフ（NG除外 & シフト適合）
        const dayLabel = dayNames[new Date(`${date}T00:00:00`).getDay()-1] || dayNames[(new Date(`${date}T00:00:00`).getDay()+6)%7];
        const cands = staff.filter(sf=>{
          const okShift = shifts.some(sh=> sh.staffId===sf.id && sh.days.includes(dayLabel) && sh.start<=st && sh.end>=en);
          const okNG = !(sf.ngUserIds||[]).includes(s.userId);
          return okShift && okNG;
        });
        const opts = cands.map(c=>`<option value="${c.id}">${c.name}（${c.type==='FT'?'常勤':'非常勤'}）</option>`).join('');
        return `
          <tr data-idx="${idx}">
            <td>${date}</td>
            <td><input type="time" class="sk-st" value="${st}"></td>
            <td><input type="time" class="sk-en" value="${en}"></td>
            <td>${uname}</td>
            <td><select class="sk-staff"><option value="">選択</option>${opts}</select></td>
            <td>${s.reason||''}</td>
            <td><button class="btn primary sk-place">配置</button></td>
          </tr>
        `;
      }).join('');

      box.innerHTML=`
        <h3>見送り一覧（編集して配置できます）</h3>
        <div style="max-height:50vh; overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="text-align:left;">
                <th>日付</th><th>開始</th><th>終了</th><th>利用者</th><th>スタッフ</th><th>理由</th><th></th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="7" style="padding:8px;">見送りはありません</td></tr>`}
            </tbody>
          </table>
        </div>
        <div class="actions">
          <button id="skClose" class="btn ghost">閉じる</button>
        </div>
      `;
      document.body.appendChild(overlay); document.body.appendChild(box);

      box.addEventListener('click', (e)=>{
        const t=e.target;
        if(!(t instanceof HTMLElement)) return;
        if(t.classList.contains('sk-place')){
          const tr=t.closest('tr'); const idx=parseInt(tr.dataset.idx);
          const rec=skippedAssignments[idx]; if(!rec) return;
          const st=tr.querySelector('.sk-st').value || rec.start;
          const en=tr.querySelector('.sk-en').value || rec.end;
          const sid=tr.querySelector('.sk-staff').value;
          if(!sid) return alert('スタッフを選択してください');

          const sf=staff.find(x=>x.id===sid); const u=users.find(x=>x.id===rec.userId);
          if(!sf || !u) return;

          const startISO = `${rec.date}T${st}:00`;
          const endISO   = `${rec.date}T${en}:00`;
          // 追加
          events.push({ title:`${u.name}（${sf.name}）`, start:startISO, end:endISO });
          // 見送りから削除
          skippedAssignments.splice(idx,1);
          // 行を消す
          tr.remove();
          save(); calendar.refetchEvents();
        }
      });

      document.getElementById('skClose').onclick=()=>{ overlay.remove(); box.remove(); };
      overlay.onclick=()=>{ overlay.remove(); box.remove(); };
    }

    // ====== Header buttons ======
    el.btnResetWeek.onclick=()=>{
      const {monday,nextMonday}=getWeekRange(calendar.getDate());
      calendar.getEvents().forEach(ev=>{ if(ev.start>=monday && ev.start<nextMonday) ev.remove(); });
      persistEvents();
    };

    el.btnExportExcel.onclick=()=>{
      const {monday,nextMonday}=getWeekRange(calendar.getDate());
      const rows=[["日付","曜日","開始","終了","利用者","スタッフ","分数"]];
      const jp=['日','月','火','水','木','金','土'];
      calendar.getEvents().forEach(ev=>{
        if(!(ev.start>=monday && ev.start<nextMonday)) return;
        const m=/^(.*)（(.*)）$/.exec(ev.title||''); const user=m?m[1]:''; const stf=m?m[2]:'';
        const s=ev.start, e=ev.end|| new Date(s.getTime()+30*60000);
        rows.push([fmtDateLocal(s),jp[s.getDay()],s.toTimeString().slice(0,5),e.toTimeString().slice(0,5),user,stf, Math.round((e-s)/60000)]);
      });
      const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      const wk=fmtDateLocal(getWeekRange(calendar.getDate()).monday);
      a.href=URL.createObjectURL(blob);
      a.download=`訪問看護_週次_${wk}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // A4印刷（現在ビューをそのまま）
    function injectPageRuleByCurrentView(){
      const old = document.getElementById('printPageRule'); if(old) old.remove();
      const style = document.createElement('style');
      style.id = 'printPageRule';
      style.media = 'print';
      const isWeek = /Week/i.test(calendar.view.type);
      const rule = isWeek ? '@page{ size: A4 landscape; margin:6mm; }'
                          : '@page{ size: A4 portrait;  margin:8mm; }';
      style.appendChild(document.createTextNode(rule));
      document.head.appendChild(style);
    }
    function printCurrentView(){
      const hadSidebar = document.body.classList.contains('sidebar-collapsed');
      const hadEdge    = document.body.classList.contains('edge-to-edge');
      document.body.classList.add('sidebar-collapsed','edge-to-edge');

      injectPageRuleByCurrentView();

      calendar.refetchEvents();
      calendar.updateSize();
      calendar.render();

      const cleanup = ()=>{
        const s = document.getElementById('printPageRule'); if(s) s.remove();
        document.body.classList.toggle('sidebar-collapsed', hadSidebar);
        document.body.classList.toggle('edge-to-edge',     hadEdge);
        setTimeout(()=>calendar.updateSize(), 0);
        window.removeEventListener('afterprint', cleanup);
      };
      window.addEventListener('afterprint', cleanup);

      requestAnimationFrame(()=>{
        void document.body.offsetHeight;
        setTimeout(()=> window.print(), 160);
      });
    }
    el.btnPrintCurrentA4.addEventListener('click', printCurrentView);

    // 左下 自動割当
    el.btnAutoAssignBottom.addEventListener('click',autoAssignWeek);

    // 折りたたみ制御（スタッフ/利用者/パターン/シフト）
    function setupCollapsible(listEl){
      if(!listEl || listEl.dataset.collapsibleInit === '1') return;
      listEl.dataset.collapsibleInit = '1';
      listEl.classList.add('list-collapsed');
      let btn = listEl.nextElementSibling;
      if(!(btn && btn.classList && btn.classList.contains('show-more-btn'))){
        btn = document.createElement('button'); btn.className='show-more-btn'; listEl.after(btn);
      }
      const setLabel = ()=> { btn.textContent = listEl.classList.contains('list-collapsed') ? 'もっと見る' : '閉じる'; };
      btn.style.display = 'block'; setLabel();
      btn.addEventListener('click', ()=>{
        listEl.classList.toggle('list-collapsed'); setLabel(); setTimeout(()=>calendar.updateSize(), 0);
      });
      new MutationObserver(()=>{ setLabel(); }).observe(listEl, {childList:true});
    }

    // ヘッダー表示/非表示（復帰ボタン常設）
    el.btnToggleHeader?.addEventListener('click',()=>{ document.body.classList.add('header-hidden'); });
    el.btnShowHeader?.addEventListener('click',()=>{ document.body.classList.remove('header-hidden'); });

    // 横幅：サイドバーだけトグル
    (function setupWideToggles(){
      const btnToggleSidebar = el.btnToggleSidebar;
      if(!btnToggleSidebar) return;
      btnToggleSidebar.addEventListener('click', ()=>{
        document.body.classList.toggle('sidebar-collapsed');
        setTimeout(()=> calendar.updateSize(), 0);
      });
      setTimeout(()=> calendar.updateSize(), 0);
    })();

    // ====== Init ======
    load();
    renderWeekdayChecks(el.patternDays);
    renderWeekdayChecks(el.shiftDays);
    renderAll();
    ['staffList','userList','patternList','shiftList'].forEach(id=> setupCollapsible(document.getElementById(id)));
    calendar.render();
  });
  </script>
</body>
</html>